# Agent2RSS 多频道使用指南

## 概述

Agent2RSS 2.0 现在支持多个独立的 RSS Feed 频道，每个频道有独立的配置和文章。

## 核心概念

### 频道 (Channel)
频道是独立的内容容器，每个频道有：
- 唯一 ID（用于 URL 路径）
- 显示名称
- 描述
- 独立的主题设置
- 独立的文章列表

### 工作流程
1. **一次性设置**：通过 API 创建频道
2. **重复使用**：发布文章时只需指定频道 ID
3. **订阅 RSS**：通过 URL 访问对应频道的 RSS Feed

---

## API 接口

### 1. 创建频道

**端点**: `POST /api/channels`

**鉴权**: 需要全局 `X-Auth-Token`

**请求体**:
```json
{
  "id": "tech",              // 必填，频道唯一标识
  "name": "科技频道",         // 必填，显示名称
  "description": "最新科技资讯", // 必填，RSS 描述
  "theme": "github",         // 可选，主题（默认：spring）
  "language": "zh-CN",       // 可选，语言（默认：zh-CN）
  "maxPosts": 50             // 可选，最大文章数（默认：100）
}
```

**示例**:
```bash
curl -X POST http://localhost:8765/api/channels \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "id": "tech",
    "name": "科技频道",
    "description": "最新科技资讯和趋势",
    "theme": "github"
  }'
```

**响应**:
```json
{
  "success": true,
  "message": "Channel created",
  "channel": {
    "id": "tech",
    "name": "科技频道",
    "description": "最新科技资讯和趋势",
    "theme": "github",
    "language": "zh-CN",
    "maxPosts": null,
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-01-15T10:00:00.000Z"
  }
}
```

---

### 2. 发布文章

**端点**: `POST /api/webhook`

**鉴权**: 需要全局 `X-Auth-Token`

**重要变更**: `channel` 参数现在是**必填**的！

**请求体**:
```json
{
  "title": "文章标题",
  "link": "https://example.com/article",  // 可选，不提供则自动生成内部链接
  "content": "# Markdown 内容\n\n文章正文...",
  "channel": "tech",           // 必填，目标频道 ID
  "contentType": "markdown",   // 可选，markdown 或 html
  "theme": "github",           // 可选，覆盖频道默认主题
  "description": "摘要",       // 可选
  "tags": ["AI", "科技"],      // 可选
  "author": "作者名"           // 可选
}
```

**重要说明**：
- `link` 参数现在是**可选**的
- 如果不提供，系统会自动生成内部永久链接：`{FEED_URL}/channels/{channelId}/posts/{postId}`
- 这对 AI 生成的内容特别有用，因为 AI 生成的内容通常没有外部链接
- 详见：[AI 内容链接处理方案](./AI_CONTENT_LINKS.md)

**示例 1：AI 生成内容（无外部链接）**:
```bash
curl -X POST http://localhost:8765/api/webhook \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "title": "今日 AI 新闻摘要",
    "content": "# AI 新闻\n\n今天发生的重要事件...",
    "channel": "tech"
  }'
```

**自动生成的链接**：`http://localhost:8765/channels/tech/posts/{uuid}`

**示例 2：转载内容（有外部链接）**:
```bash
curl -X POST http://localhost:8765/api/webhook \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "title": "AI 新突破",
    "link": "https://example.com/ai-breakthrough",
    "content": "# AI 突破\n\n今天发生重大突破...",
    "channel": "tech"
  }'
```

**响应**:
```json
{
  "success": true,
  "message": "Post added to channel \"tech\"",
  "post": {
    "id": "uuid-here",
    "title": "AI 新突破",
    "channel": "tech",
    "pubDate": "2025-01-15T10:05:00.000Z"
  }
}
```

---

### 3. 获取频道列表

**端点**: `GET /api/channels`

**无需鉴权**

**示例**:
```bash
curl http://localhost:8765/api/channels
```

**响应**:
```json
[
  {
    "id": "default",
    "name": "默认频道",
    "description": "AI Briefing - Daily news summaries generated by AI.",
    "theme": "spring",
    "language": "zh-CN",
    "maxPosts": null,
    "postCount": 5,
    "createdAt": "2025-01-15T00:00:00.000Z",
    "updatedAt": "2025-01-15T00:00:00.000Z"
  },
  {
    "id": "tech",
    "name": "科技频道",
    "description": "最新科技资讯和趋势",
    "theme": "github",
    "language": "zh-CN",
    "maxPosts": null,
    "postCount": 10,
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-01-15T10:00:00.000Z"
  }
]
```

---

### 4. 获取单个频道

**端点**: `GET /api/channels/:id`

**无需鉴权**

**示例**:
```bash
curl http://localhost:8765/api/channels/tech
```

---

### 5. 更新频道

**端点**: `PUT /api/channels/:id`

**无需鉴权**（建议未来添加）

**请求体** (所有字段可选):
```json
{
  "name": "新名称",
  "description": "新描述",
  "theme": "spring",
  "language": "en",
  "maxPosts": 200
}
```

**示例**:
```bash
curl -X PUT http://localhost:8765/api/channels/tech \
  -H "Content-Type: application/json" \
  -d '{
    "name": "科技频道（已更新）",
    "description": "新的描述"
  }'
```

---

### 6. 删除频道

**端点**: `DELETE /api/channels/:id`

**无需鉴权**（建议未来添加）

**重要**: 删除频道会删除该频道的所有文章，且不可恢复。不能删除 `default` 频道。

**示例**:
```bash
curl -X DELETE http://localhost:8765/api/channels/tech
```

---

## RSS Feed 访问

### 频道专属 RSS

每个频道有独立的 RSS Feed：

```
/channels/{channelId}/rss.xml
```

**示例**:
- 科技频道: `http://localhost:8765/channels/tech/rss.xml`
- 新闻频道: `http://localhost:8765/channels/news/rss.xml`
- 默认频道: `http://localhost:8765/channels/default/rss.xml`

### 聚合 RSS

获取所有频道的最新文章：

```
/rss.xml
```

**示例**: `http://localhost:8765/rss.xml`

---

## 完整使用示例

### 场景：创建三个频道并发布文章

#### 1. 创建频道

```bash
# 创建科技频道
curl -X POST http://localhost:8765/api/channels \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "id": "tech",
    "name": "科技频道",
    "description": "最新科技资讯和趋势",
    "theme": "github"
  }'

# 创建新闻频道
curl -X POST http://localhost:8765/api/channels \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "id": "news",
    "name": "新闻频道",
    "description": "每日新闻汇总",
    "theme": "modern"
  }'

# 创建博客频道
curl -X POST http://localhost:8765/api/channels \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "id": "blog",
    "name": "博客频道",
    "description": "个人博客文章",
    "theme": "spring"
  }'
```

#### 2. 发布文章

```bash
# 发布到科技频道
curl -X POST http://localhost:8765/api/webhook \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "title": "GPT-5 发布",
    "link": "https://example.com/gpt5",
    "content": "# GPT-5 发布\n\nOpenAI 今天发布了 GPT-5...",
    "channel": "tech"
  }'

# 发布到新闻频道
curl -X POST http://localhost:8765/api/webhook \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "title": "今日要闻",
    "link": "https://example.com/news",
    "content": "# 今日要闻\n\n1. ...\n2. ...",
    "channel": "news"
  }'

# 发布到博客频道
curl -X POST http://localhost:8765/api/webhook \
  -H "Content-Type: application/json" \
  -H "X-Auth-Token: your-token" \
  -d '{
    "title": "我的第一篇博客",
    "link": "https://example.com/blog/1",
    "content": "# 我的第一篇博客\n\n欢迎来到我的博客...",
    "channel": "blog"
  }'
```

#### 3. 订阅 RSS

在 RSS 阅读器中订阅：

- 科技频道: `http://localhost:8765/channels/tech/rss.xml`
- 新闻频道: `http://localhost:8765/channels/news/rss.xml`
- 博客频道: `http://localhost:8765/channels/blog/rss.xml`
- 所有文章: `http://localhost:8765/rss.xml`

---

## 数据存储

### 数据结构

所有数据存储在 `data/data.json`：

```json
{
  "posts": [
    {
      "id": "uuid",
      "channel": "tech",
      "title": "文章标题",
      "link": "https://...",
      "content": "<html>...</html>",
      "contentMarkdown": "# Markdown",
      "summary": "摘要",
      "tags": ["tag1"],
      "author": "作者",
      "pubDate": "2025-01-15T10:00:00.000Z"
    }
  ],
  "channels": {
    "tech": {
      "id": "tech",
      "name": "科技频道",
      "description": "描述",
      "theme": "github",
      "language": "zh-CN",
      "maxPosts": 100,
      "createdAt": "2025-01-15T10:00:00.000Z",
      "updatedAt": "2025-01-15T10:00:00.000Z"
    }
  }
}
```

---

## 错误处理

### 常见错误

#### 1. 频道不存在
```json
{
  "error": "Channel \"tech\" not found"
}
```
**解决**: 先创建频道，再发布文章

#### 2. 鉴权失败
```json
{
  "error": "Unauthorized"
}
```
**解决**: 检查 `X-Auth-Token` 是否正确

#### 3. 频道已存在
```json
{
  "error": "Channel \"tech\" already exists"
}
```
**解决**: 使用不同的频道 ID，或更新现有频道

#### 4. 不能删除默认频道
```json
{
  "error": "Cannot delete default channel"
}
```
**解决**: 默认频道不能删除

---

## 迁移指南

### 从旧版本升级

如果你之前使用的是单频道版本：

1. **备份数据**: 备份 `data/posts.json`

2. **更新代码**: 拉取最新代码

3. **迁移数据** (可选):
   ```bash
   # 旧文章会保留，但没有 channel 字段
   # 建议重新发布或手动迁移
   ```

4. **更新 Webhook 调用**:
   - 添加 `channel` 参数（必填）
   - 示例：
     ```bash
     # 旧版本
     curl -X POST http://localhost:8765/api/webhook \
       -H "X-Auth-Token: your-token" \
       -d '{"title": "...", "link": "...", "content": "..."}'

     # 新版本（必须添加 channel）
     curl -X POST http://localhost:8765/api/webhook \
       -H "X-Auth-Token: your-token" \
       -d '{"title": "...", "link": "...", "content": "...", "channel": "default"}'
     ```

---

## 环境变量

```bash
# 服务配置
PORT=8765                           # 服务端口

# 鉴权配置
AUTH_TOKEN=your-secret-token        # 全局鉴权 Token

# RSS Feed 配置
FEED_TITLE=AI Briefing              # 聚合 Feed 标题
FEED_DESCRIPTION=Daily summaries    # 聚合 Feed 描述
FEED_URL=http://localhost:8765      # 服务 URL

# 默认频道
DEFAULT_CHANNEL=default             # 默认频道 ID
```

---

## 最佳实践

### 1. 频道 ID 命名

使用简洁的英文 ID：
- ✅ `tech`, `news`, `blog`, `docs`
- ❌ `科技频道`, `新闻快讯`, `我的博客`

### 2. 频道规划

根据内容类型划分频道：
- 按主题：`tech`, `finance`, `sports`
- 按来源：`twitter`, `blog`, `newsletter`
- 按语言：`zh`, `en`, `ja`

### 3. 主题选择

为不同频道选择不同主题：
- 技术文档：`github`, `monokai`
- 新闻资讯：`modern`, `clean`
- 个人博客：`spring`, `warm`

### 4. 文章数量限制

根据更新频率设置 `maxPosts`：
- 高频更新：`50-100`
- 低频更新：`20-50`

---

## 常见问题

### Q: 可以修改频道 ID 吗？
**A**: 不可以。频道 ID 创建后不能修改，如需更改请创建新频道。

### Q: 删除频道的文章能恢复吗？
**A**: 不能。删除频道会永久删除该频道的所有文章，操作前请备份。

### Q: 可以为不同频道设置不同的鉴权 Token 吗？
**A**: 目前所有频道共享一个全局 Token。未来版本可能支持独立 Token。

### Q: RSS 聚合 Feed 包含哪些文章？
**A**: 包含所有频道的最新文章，按时间倒序排列。

### Q: 如何将旧数据迁移到新频道？
**A**:
1. 读取 `data/posts.json`
2. 为每篇文章添加 `channel` 字段
3. 调用 API 重新发布，或直接修改 `data/data.json`

---

## 技术支持

如有问题，请访问：
- GitHub Issues: [链接]
- 文档: [链接]
- 示例代码: `docs/examples/`
